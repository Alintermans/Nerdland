<!DOCTYPE html>
<html>
<head>
	<title>Four Quadrant Chart with Live Updates</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<style>
		.container {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			grid-template-rows: repeat(2, 1fr);
			grid-gap: 20px;
			height: 50vh;
		}

		.chart-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 10px;
			border: 1px solid #ccc;
		}

		h1, h2 {
			text-align: center;
			margin: 0;
			margin-bottom: 10px;
		}

		button {
			margin: 10px;
			padding: 5px 10px;
			border: none;
			border-radius: 5px;
			background-color: #007bff;
			color: #fff;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		button:hover {
			background-color: #0062cc;
		}

		charts {
			position: relative; height:40vh; width:80vw
		}

		.error-box {
			position: fixed;
			top: 40px;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 20px;
			background-color: #ff3333;
			color: white;
			border-radius: 5px;
			z-index: 9999;
		}
	</style>
</head>
<body>
	<div id="error-container"></div>
	<div class="container">
		<div class="chart-container">
			<h1>Car 1</h1>
			<h2 id="subtitle_1"></h2>
			<canvas id="chart1" class="charts"></canvas>
			<div>
				<button id="btn1" onclick="start_button(0)">Start</button>
				<button id="btn2" onclick="stop_button(0)">Stop</button>
				<button id="btn3"  onclick="download_svg_button(0)">Download SVG</button>
			</div>
		</div>
		<div class="chart-container">
			<h1>Car 2</h1>
			<h2 id="subtitle_2"></h2>
			<canvas id="chart2" class="charts" ></canvas>
			<div>
				<button id="btn4" onclick="start_button(1)">Start</button>
				<button id="btn5" onclick="stop_button(1)">Stop</button>
				<button id="btn6" onclick="download_svg_button(1)">Download SVG</button>
			</div>
		</div>
		<div class="chart-container">
			<h1>Car 3</h1>
			<h2 id="subtitle_3"></h2>
			<canvas id="chart3" class="charts"></canvas>
			<div>
				<button id="btn7" onclick="start_button(2)">Start</button>
				<button id="btn8" onclick="stop_button(2)">Stop</button>
				<button id="btn9" onclick="download_svg_button(2)">Download SVG</button>
			</div>
		</div>
		<div class="chart-container">
			<h1>Car 4</h1>
			<h2 id="subtitle_4"></h2>
			<canvas id="chart4" class="charts"></canvas>
			<div>
				<button id="btn10" onclick="start_button(3)">Start</button>
				<button id="btn11" onclick="stop_button(3)">Stop</button>
				<button id="btn12" onclick="download_svg_button(3)">Download SVG</button>
				
			</div>
		</div>
	</div>

	<script>
				// Initialize the charts
                var chart1 = createChart('chart1', 'Car 1', '#007bff');
		var chart2 = createChart('chart2', 'Car 2', '#dc3545');
		var chart3 = createChart('chart3', 'Car 3', '#ffc107');
		var chart4 = createChart('chart4', 'Car 4', '#28a745');

		// Connect to the EventSource and update the charts with new data
		var source = new EventSource('/stream');
		source.onmessage = function(event) {
			var data = JSON.parse(event.data);
			chart1.data.datasets[0].data = data.value_1;
			chart1.data.labels = [...Array(data.value_1.length).keys()];
			chart1.update();
			chart2.data.datasets[0].data = data.value_2;
			chart2.data.labels = [...Array(data.value_2.length).keys()];
			chart2.update();
			chart3.data.datasets[0].data = data.value_3;
			chart3.data.labels = [...Array(data.value_3.length).keys()];
			chart3.update();
			chart4.data.datasets[0].data = data.value_4;
			chart4.data.labels = [...Array(data.value_4.length).keys()];
			chart4.update();
		};

		// Helper function to create a new line chart
		function createChart(canvasId, title, color) {
			var ctx = document.getElementById(canvasId);
			var chart = new Chart(ctx, {
				type: 'line',
				data: {
				labels: ['1', '2', '3', '4', '5', '6'],
				datasets: [{
					label: title,
					data: [12, 19, 3, 5, 2, 3],
					borderWidth: 1,
					borderColor: color,
					fill: false
				}]
				},
				options: {
					responsive: true,
					scales: {
						x: {
							grid: {
								display: false
							},
							ticks: {
								display: false //this will remove only the label
							}
						},
						y: {
							grid: {
								display: false
							},
							ticks: {
								beginAtZero: true
							},
							min: 0,
							max: 1024
						}
					},
					layout: {
						padding: 20
					},
					elements: {
						point:{
							radius: 0
						}
					},
					animation: {
					duration: 0
				}

				}
			});
			return chart;
		}


		function start_button(val) {
			fetch(`/start_button_pressed?value=${val}`)
			.then(response => response.json())
			.then(data => console.log(data));
		}

		function stop_button(val) {
			fetch(`/stop_button_pressed?value=${val}`)
			.then(response => response.json())
			.then(data => console.log(data));
		}

		function generate_and_download_svg_file(data) {
			const width = 500;
			const height = 300;
			const margin = 20;

			const xScale = d3.scaleLinear()
				.domain([0, data.length - 1])
				.range([margin, width - margin]);

			const yScale = d3.scaleLinear()
				.domain([0, d3.max(data)])
				.range([height - margin, margin]);

			const line = d3.line()
				.x((d, i) => xScale(i))
				.y(d => yScale(d))
				.curve(d3.curveMonotoneX);

			const svg = d3.create("svg")
				.attr("viewBox", `0 0 ${width} ${height}`);

			svg.append("path")
				.datum(data)
				.attr("fill", "none")
				.attr("stroke", "steelblue")
				.attr("stroke-width", 1.5)
				.attr("d", line);
			
				const svgString = new XMLSerializer().serializeToString(svg.node());
				const blob = new Blob([svgString], {type: "image/svg+xml"});
				const url = URL.createObjectURL(blob);
				const link = document.createElement("a");
				link.download = "graph.svg";
				link.href = url;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				URL.revokeObjectURL(url);
		}
		
		function download_svg_button(val) {
			fetch(`/download_svg_pressed?value=${val}`)
			.then(response => response.json())
			.then(data => generate_and_download_svg_file(data.value));
		}

		var error_box_visible = false;

		function showErrorMessage(msg) {
			error_box_visible = true;
			var errorContainer = document.getElementById("error-container");
			errorContainer.innerHTML = "<div class='error-box'>" + msg + "</div>";
		}

		function hideErrorMessage() {
			error_box_visible = false;
			var errorContainer = document.getElementById("error-container");
			errorContainer.innerHTML = "";
		}

		var error_source = new EventSource('/error_stream');
		error_source.onmessage = function(event) {
			var data = JSON.parse(event.data);
			if (data.message != "") {
				showErrorMessage(data.message);
			} else if (error_box_visible) {
				hideErrorMessage();
			}
		};

		

	</script>

  </body>
</html>